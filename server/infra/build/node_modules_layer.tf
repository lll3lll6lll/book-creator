module "triggers_server_nm" {
  source = "../../../infra/modules/builders/trigger"
  app_absolute_path = "${var.root_dir}/server"
  file_extensions  = [ "json"]
  files       = ["package.json","package-lock.json", "tsconfig.json"]
}

resource "terraform_data" "pack_node_modules" {
  triggers_replace =  {
    triggers = module.triggers_server_nm.triggers
#    force    = timestamp()
  }

  depends_on = [module.server_node_modules_bucket]

  provisioner "local-exec" {
    command = <<-EOT

      mkdir -p "${local.target_dir}" || true

      rm -f "${local.absolut_nm_name}" || true
      rm -f "${local.absolut_nm_name_zip}" || true

      mkdir -p "${local.absolut_nm_name}/nodejs" || true

      cp "${local.project_dir}/package.json" "${local.target_dir}/${local.nm_name}/nodejs/package.json"
      cp "${local.project_dir}/package-lock.json" "${local.target_dir}/${local.nm_name}/nodejs/package-lock.json"


      cd  ${local.target_dir}/${local.nm_name}/nodejs
      npm ci --prefer-offline --omit=dev --omit=optional
      cd ..
      zip -qr9 "${local.absolut_nm_name_zip}" .
      aws s3 cp "${local.absolut_nm_name_zip}" "s3://${data.aws_s3_bucket.server_node_modules_data.bucket}"

    EOT
  }

}


